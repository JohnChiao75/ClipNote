name: Release

on:
  release:
    types: [published]

jobs:
  release-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build Windows
      run: flutter build windows --release
    
    - name: Archive Windows build
      run: |
        Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath clipnote-windows-x64.zip
    
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: clipnote-windows-x64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build macOS
      run: flutter build macos --release
    
    - name: Archive macOS build
      run: |
        cd build/macos/Build/Products/Release
        zip -r clipnote-macos.zip clipnote.app
        mv clipnote-macos.zip $GITHUB_WORKSPACE/
    
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: clipnote-macos.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        channel: 'stable'
    
    - name: Install flutter dependencies
      run: flutter pub get
    
    - name: Build Linux
      run: flutter build linux --release
    
    - name: Archive Linux build
      run: |
        cd build/linux/x64/release/bundle
        tar -czf clipnote-linux-x64.tar.gz *
        mv clipnote-linux-x64.tar.gz $GITHUB_WORKSPACE/
    
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: clipnote-linux-x64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-android:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Decode keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        echo $KEYSTORE_BASE64 | base64 -d > android/app/keystore.jks
    
    - name: Create key.properties
      env:
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      run: |
        cat > android/key.properties << EOF
        storePassword=$KEYSTORE_PASSWORD
        keyPassword=$KEY_PASSWORD
        keyAlias=$KEY_ALIAS
        storeFile=keystore.jks
        EOF
    
    - name: Build APK
      run: flutter build apk --release
    
    - name: Build App Bundle
      run: flutter build appbundle --release
    
    - name: Rename artifacts
      run: |
        mv build/app/outputs/flutter-apk/app-release.apk clipnote-android.apk
        mv build/app/outputs/bundle/release/app-release.aab clipnote-android.aab
    
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          clipnote-android.apk
          clipnote-android.aab
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
